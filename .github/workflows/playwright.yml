name: playwright tests
# ĞšĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ñ‹
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
  workflow_dispatch:
# ĞĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ´Ğ¶Ğ¾Ğ±Ñ‹
jobs:
  e2eTests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²
        run: npm i
      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ñ‹
        run: npx playwright install --with-deps
      - name: Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ñ‹
        run: npm t
      # ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
      - uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results
          path: test-results
          retention-days: 20
      # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Allure
      - uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: allure-results
          path: allure-results
          retention-days: 20
      # Ğ—Ğ°Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
      - uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
      # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ· allure-results Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ allure-report
      - uses: simple-elf/allure-report-action@master
        if: always()
        id: allure-report
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20
      # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
      - name: deploy report
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.TOKEN_GIT }}
          publish_branch: gh-pages
          publish_dir: allure-history

      - name: Install allurectl
        run: |
          curl -o allurectl -L "https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64"
          chmod +x allurectl
          sudo mv allurectl /usr/local/bin/

      - name: Upload results to Allure TestOps
        if: always()
        run: |
          allurectl upload allure-results \
            --endpoint https://allure.autotests.cloud \
            --project-id 4983 \
            --token ${{ secrets.ALLURE_TOKEN }} \
            --launch-name "GitHub Run #${{ github.run_number }}"

      - name: Parse Allure summary
        id: parse_summary
        if: always()
        run: |
          SUMMARY_FILE="allure-report/widgets/summary.json"
          if [ -f "$SUMMARY_FILE" ]; then
            PASSED=$(jq '.statistic.passed' $SUMMARY_FILE)
            FAILED=$(jq '.statistic.failed' $SUMMARY_FILE)
            SKIPPED=$(jq '.statistic.skipped' $SUMMARY_FILE)
            TOTAL=$(jq '.statistic.total' $SUMMARY_FILE)
            echo "PASSED=$PASSED" >> $GITHUB_ENV
            echo "FAILED=$FAILED" >> $GITHUB_ENV
            echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
            echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          fi

      - name: Notify Telegram
        if: always()
        run: |
          STATUS=${{ job.status }}
          if [ "$STATUS" = "success" ]; then
            EMOJI="ğŸ‰"
            STATUS_TEXT="Ğ£Ğ¡ĞŸĞ•Ğ¥"
          else
            EMOJI="ğŸš¨"
            STATUS_TEXT="ĞĞ•Ğ£Ğ”ĞĞ§Ğ"
          fi

          MESSAGE="$EMOJI *$STATUS_TEXT* $EMOJI%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ“Š *Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²:*%0A\
          â–«ï¸ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ¾: *$TOTAL*%0A\
          âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ: *$PASSED*%0A\
          âŒ ĞŸÑ€Ğ¾Ğ²Ğ°Ğ»ĞµĞ½Ğ¾: *$FAILED*%0A\
          â­ï¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾: *$SKIPPED*%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ”— [Allure Ğ¾Ñ‚Ñ‡ĞµÑ‚](https://vasyen87-cyber.github.io/apiTests/)%0A\
          ğŸ§ª [Allure TestOps](https://allure.autotests.cloud/project/4984)%0A\
          ğŸ“¦ [ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ·ï¸ *Run #${{ github.run_number }}*"

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="$MESSAGE"